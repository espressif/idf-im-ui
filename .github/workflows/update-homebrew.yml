name: Update Homebrew Formula and Cask

on:
  workflow_call:
    inputs:
      version:
        description: 'The release tag name (e.g., v1.2.3) to update for'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: 'The release tag name (e.g., v1.2.3) to update for'
        required: true
        type: string

jobs:
  update-homebrew:
    name: Update Homebrew Formula and Cask
    runs-on: ubuntu-latest
    steps:
      - name: Determine tag name
        id: tag
        run: |
          TAG_NAME="${{ github.event.inputs.version }}"
          if [[ "${TAG_NAME}" == refs/tags/* ]]; then
            TAG_NAME="${TAG_NAME#refs/tags/}"
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Checkout homebrew repository
        uses: actions/checkout@v4
        with:
          repository: espressif/homebrew-eim
          token: ${{ secrets.HOMEBREW_UPDATE_TOKEN }}
          path: homebrew-repo

      - name: Get release information
        id: release-info
        run: |
          echo "version=${{ steps.tag.outputs.tag_name }}" >> $GITHUB_OUTPUT
          echo "release_url=${{ github.event.release.html_url || format('https://github.com/{0}/releases/tag/{1}', github.repository, steps.tag.outputs.tag_name) }}" >> $GITHUB_OUTPUT

      - name: Download and calculate checksums for CLI
        id: cli-checksums
        run: |
          # Authenticate the request to get proper asset URLs
          ASSETS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "${{ github.event.release.assets_url || format('https://api.github.com/repos/{0}/releases/tags/{1}', github.repository, steps.tag.outputs.tag_name) }}")

          # macOS x64 CLI
          macos_x64_url=$(echo "$ASSETS" | jq -r '.[] | select(.name == "eim-cli-macos-x64.zip") | .browser_download_url')
          wget -q "$macos_x64_url" -O eim-cli-macos-x64.zip
          macos_x64_sha=$(sha256sum eim-cli-macos-x64.zip | cut -d' ' -f1)

          # macOS ARM64 CLI
          macos_arm64_url=$(echo "$ASSETS" | jq -r '.[] | select(.name == "eim-cli-macos-aarch64.zip") | .browser_download_url')
          wget -q "$macos_arm64_url" -O eim-cli-macos-aarch64.zip
          macos_arm64_sha=$(sha256sum eim-cli-macos-aarch64.zip | cut -d' ' -f1)

          echo "macos_x64_url=$macos_x64_url" >> $GITHUB_OUTPUT
          echo "macos_x64_sha=$macos_x64_sha" >> $GITHUB_OUTPUT
          echo "macos_arm64_url=$macos_arm64_url" >> $GITHUB_OUTPUT
          echo "macos_arm64_sha=$macos_arm64_sha" >> $GITHUB_OUTPUT

      - name: Download and calculate checksums for GUI
        id: gui-checksums
        run: |
          ASSETS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "${{ github.event.release.assets_url || format('https://api.github.com/repos/{0}/releases/tags/{1}', github.repository, steps.tag.outputs.tag_name) }}")

          # macOS x64 GUI (DMG)
          macos_x64_gui_url=$(echo "$ASSETS" | jq -r '.[] | select(.name == "eim-gui-macos-x64.dmg") | .browser_download_url')
          wget -q "$macos_x64_gui_url" -O eim-gui-macos-x64.dmg
          macos_x64_gui_sha=$(sha256sum eim-gui-macos-x64.dmg | cut -d' ' -f1)

          # macOS ARM64 GUI (DMG)
          macos_arm64_gui_url=$(echo "$ASSETS" | jq -r '.[] | select(.name == "eim-gui-macos-aarch64.dmg") | .browser_download_url')
          wget -q "$macos_arm64_gui_url" -O eim-gui-macos-aarch64.dmg
          macos_arm64_gui_sha=$(sha256sum eim-gui-macos-aarch64.dmg | cut -d' ' -f1)

          echo "macos_x64_gui_url=$macos_x64_gui_url" >> $GITHUB_OUTPUT
          echo "macos_x64_gui_sha=$macos_x64_gui_sha" >> $GITHUB_OUTPUT
          echo "macos_arm64_gui_url=$macos_arm64_gui_url" >> $GITHUB_OUTPUT
          echo "macos_arm64_gui_sha=$macos_arm64_gui_sha" >> $GITHUB_OUTPUT

      - name: Generate Homebrew Formula for CLI
        env:
          VERSION: ${{ steps.release-info.outputs.version }}
          MACOS_X64_URL: ${{ steps.cli-checksums.outputs.macos_x64_url }}
          MACOS_X64_SHA: ${{ steps.cli-checksums.outputs.macos_x64_sha }}
          MACOS_ARM64_URL: ${{ steps.cli-checksums.outputs.macos_arm64_url }}
          MACOS_ARM64_SHA: ${{ steps.cli-checksums.outputs.macos_arm64_sha }}
        run: |
          mkdir -p homebrew-repo/Formula

          # Remove 'v' prefix from version for formula
          CLEAN_VERSION="${VERSION#v}"

          cat > homebrew-repo/Formula/eim.rb << 'FORMULA_EOF'
          # typed: false
          # frozen_string_literal: true

          class Eim < Formula
            desc "ESP-IDF Installation Manager - CLI tool for setting up ESP-IDF development environment"
            homepage "https://github.com/espressif/idf-im-ui"
          FORMULA_EOF

          cat >> homebrew-repo/Formula/eim.rb << FORMULA_EOF
            version "${CLEAN_VERSION}"
            license "MIT"

            on_macos do
              on_intel do
                url "${MACOS_X64_URL}"
                sha256 "${MACOS_X64_SHA}"
              end
              on_arm do
                url "${MACOS_ARM64_URL}"
                sha256 "${MACOS_ARM64_SHA}"
              end
            end

            # Runtime dependencies for QEMU (used by ESP-IDF for emulation)
            depends_on "libgcrypt"
            depends_on "glib"
            depends_on "pixman"
            depends_on "sdl2"
            depends_on "libslirp"

            # DFU utility for flashing
            depends_on "dfu-util"

            # ESP-IDF requires Python 3.9-3.13. We install python@3.12 as default.
            # If user already has python@3.12, Homebrew won't reinstall it.
            depends_on "python@3.12"

            def install
              bin.install "eim"
            end

            def caveats
              <<~EOS
                ESP-IDF Installation Manager (EIM) has been installed.

                Python 3.12 was installed as a dependency (ESP-IDF requires Python 3.9-3.13).
                Python 3.14+ is not yet supported.

                Run 'eim' to install ESP-IDF.
              EOS
            end

            test do
              assert_match "eim", shell_output("#{bin}/eim --version")
            end
          end
          FORMULA_EOF

          echo "Generated CLI formula:"
          cat homebrew-repo/Formula/eim.rb

      - name: Generate Homebrew Cask for GUI
        env:
          VERSION: ${{ steps.release-info.outputs.version }}
          MACOS_X64_GUI_URL: ${{ steps.gui-checksums.outputs.macos_x64_gui_url }}
          MACOS_X64_GUI_SHA: ${{ steps.gui-checksums.outputs.macos_x64_gui_sha }}
          MACOS_ARM64_GUI_URL: ${{ steps.gui-checksums.outputs.macos_arm64_gui_url }}
          MACOS_ARM64_GUI_SHA: ${{ steps.gui-checksums.outputs.macos_arm64_gui_sha }}
        run: |
          mkdir -p homebrew-repo/Casks

          # Remove 'v' prefix from version for cask
          CLEAN_VERSION="${VERSION#v}"

          cat > homebrew-repo/Casks/eim-gui.rb << CASK_EOF
          cask "eim-gui" do
            version "${CLEAN_VERSION}"

            on_intel do
              url "${MACOS_X64_GUI_URL}"
              sha256 "${MACOS_X64_GUI_SHA}"
            end
            on_arm do
              url "${MACOS_ARM64_GUI_URL}"
              sha256 "${MACOS_ARM64_GUI_SHA}"
            end

            name "ESP-IDF Installation Manager"
            desc "GUI application for installing and managing ESP-IDF development environment"
            homepage "https://github.com/espressif/idf-im-ui"

            app "eim.app"

            caveats <<~EOS
              ESP-IDF Installation Manager (EIM) has been installed.

              IMPORTANT: ESP-IDF requires Python 3.9, 3.10, 3.11, 3.12, or 3.13.
              Python 3.14+ is not yet supported.

              If you don't have a compatible Python version, install one with:
                brew install python@3.12

              For QEMU emulation support, you may also need:
                brew install libgcrypt glib pixman sdl2 libslirp dfu-util
            EOS

            zap trash: [
              "~/Library/Application Support/com.espressif.eim",
              "~/Library/Caches/com.espressif.eim",
              "~/Library/Preferences/com.espressif.eim.plist",
              "~/Library/Saved Application State/com.espressif.eim.savedState",
            ]
          end
          CASK_EOF

          echo "Generated GUI cask:"
          cat homebrew-repo/Casks/eim-gui.rb

      - name: Commit and push changes
        run: |
          cd homebrew-repo
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Formula/eim.rb Casks/eim-gui.rb
          git diff --staged --quiet || git commit -m "Update eim to version ${{ steps.release-info.outputs.version }}"
          git push
