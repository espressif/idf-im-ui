name: Autotest CLI

on:
  workflow_call:
    inputs:
      run_id:
        required: true
        type: string
      ref:
        required: true
        type: string
      run_extended:
        required: true
        type: string
        default: "false"
      run_self_hosted:
        required: true
        type: string
        default: "false"

  workflow_dispatch:
    inputs:
      run_id:
        description: "The run id from which to take binaries"
        required: true
        type: string
      run_extended:
        description: "Run extended tests, use 'true' to enable"
        required: true
        type: string
        default: "false"
      run_self_hosted:
        description: "Run tests on self-hosted runner in CN, use 'true' to enable"
        required: true
        type: string
        default: "false"

jobs:
  test:
    name: CLI (${{ matrix.package_name }}${{ matrix.run_on == 'MirrorRunner' && '-AlternateMirrors' || '' }}${{ matrix.os == 'self-hosted' && '-CN' || '' }}) ${{ matrix.distro_name || '' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            package_name: linux-x64
            container: ubuntu:latest
            node_arch: x64
            distro_name: ubuntu
          - os: ubuntu-24.04-arm
            package_name: linux-aarch64
            container: ubuntu:latest
            node_arch: arm64
            distro_name: ubuntu
          - os: ubuntu-latest
            package_name: linux-x64
            container: debian:latest
            node_arch: x64
            distro_name: debian
          - os: ubuntu-latest
            package_name: linux-x64
            container: fedora:latest
            node_arch: x64
            distro_name: fedora
          - os: ubuntu-latest
            package_name: linux-x64
            container: opensuse/tumbleweed:latest
            node_arch: x64
            distro_name: opensuse
          - os: ubuntu-latest
            package_name: linux-x64
            container: archlinux:base
            node_arch: x64
            distro_name: archlinux
          - os: macos-latest
            package_name: macos-aarch64
          - os: macos-15-intel
            package_name: macos-x64
          - os: windows-latest
            package_name: windows-x64
            distro_name: stock
          # - os: windows-latest
          #   package_name: windows-x64
          #   distro_name: scoop
          - os: ${{ inputs.run_self_hosted == 'true' && 'self-hosted' || 'ubuntu-latest' }}
            package_name: linux-x64
            run_on: MirrorRunner

    steps:
      - name: Free Disk Space (Ubuntu)
        if: matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm'
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: false
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up Python
        if: matrix.distro_name != 'scoop'
        uses: actions/setup-python@v6
        with:
          python-version: "3.13.8"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: eim-cli-${{ matrix.package_name }}-*
          path: ./artifacts
          merge-multiple: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.run_id }}

      # Non-Windows steps

      - name: Get CLI application version number (non-Windows)
        if: matrix.os != 'windows-latest'
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag --sort=-creatordate | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)
          STRIPPED_TAG=${LATEST_TAG#v}
          echo "CLI_TAG=$STRIPPED_TAG" >> $GITHUB_ENV

      - name: Check artifact and make it executable (non-Windows)
        if: matrix.os != 'windows-latest'
        run: |
          ls -la ./artifacts/
          chmod +x artifacts/eim

      # Linux steps
      - name: Build node test dependencies on Linux runner (Linux only)
        if: matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm'
        working-directory: tests
        run: |
          npm ci

      - name: Start test container (Linux only)
        if: (matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm') && matrix.run_on != 'MirrorRunner'
        run: |
          docker create --name test-runner \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace/tests \
            -e LOG_TO_FILE=true \
            -e PACKAGE_NAME=${{ matrix.package_name }} \
            -e PREREQUISITES_OS="${{ matrix.distro_name || 'ubuntu:24.04' }}" \
            -e EIM_CLI_PATH=/workspace/artifacts/eim \
            -e EIM_CLI_VERSION="eim ${{ env.CLI_TAG }}" \
            ${{ matrix.container || 'ubuntu:24.04' }} \
            sleep infinity
          docker start test-runner
          docker exec test-runner bash -c "
            if command -v apt-get &>/dev/null; then
              apt-get update && apt-get install -y curl ca-certificates which
            elif command -v dnf &>/dev/null; then
              dnf install -y curl ca-certificates which tar gzip
            elif command -v pacman &>/dev/null; then
              pacman -Syu --noconfirm curl ca-certificates which
            elif command -v zypper &>/dev/null; then
              zypper install -y curl ca-certificates which tar gzip
            else
              echo 'No supported package manager found' && exit 1
            fi
            curl -fsSL https://nodejs.org/dist/v20.20.0/node-v20.20.0-linux-${{matrix.node_arch}}.tar.gz | tar -xz -C /usr/local --strip-components=1
            node --version
            npm --version
            cat /etc/os-release
          "

      - name: Run prerequisites check (Linux only)
        if: (matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm') && matrix.run_on != 'MirrorRunner'
        run: |
          docker exec test-runner npm run test-CLI --file=CLI-prerequisites
        continue-on-error: true

      - name: Install pre-requisites (Linux only)
        if: (matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm') && matrix.run_on != 'MirrorRunner'
        run: |
          docker exec test-runner \
            bash -c "
              if command -v apt-get &>/dev/null; then
                apt-get update
                apt-get install -y git cmake wget flex bison gperf ccache libffi-dev libssl-dev dfu-util libusb-1.0-0-dev
              elif command -v dnf &>/dev/null; then
                dnf install -y git cmake wget flex bison gperf ccache libffi-devel openssl-devel dfu-util libusb1-devel
              elif command -v yum &>/dev/null; then
                yum install -y git cmake wget flex bison gperf ccache libffi-devel openssl-devel dfu-util libusb1-devel
              elif command -v pacman &>/dev/null; then
                pacman -Syu --noconfirm git cmake wget flex bison gperf ccache libffi openssl dfu-util libusb
              elif command -v zypper &>/dev/null; then
                pkill -9 zypper 2>/dev/null || true
                rm -f /run/zypp.pid 2>/dev/null || true
                zypper install -y git cmake wget flex bison gperf ccache libffi-devel libopenssl-devel dfu-util libusb-1_0-0
              else
                echo 'Unknown package manager' && exit 1
              fi
            "

      - name: Run python check (Linux only)
        if: (matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm') && matrix.run_on != 'MirrorRunner'
        run: |
          docker exec test-runner \
            bash -c "
              npm run test-CLI --file=CLI-pythoncheck
            "
        continue-on-error: true

      - name: Install python (Linux Only)
        if: (matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm') && matrix.run_on != 'MirrorRunner'
        run: |
          docker exec test-runner \
            bash -c "
              if command -v apt-get &>/dev/null; then
                apt-get install -y python3 python3-pip python3-venv
              elif command -v dnf &>/dev/null; then
                dnf install -y python3 python3-pip
              elif command -v yum &>/dev/null; then
                yum install -y python3 python3-pip
              elif command -v pacman &>/dev/null; then
                pacman -S --noconfirm python python-pip
              elif command -v zypper &>/dev/null; then
                pkill -9 zypper 2>/dev/null || true
                rm -f /run/zypp.pid 2>/dev/null || true                
                zypper install -y python3 python3-pip
              else
                echo 'Unknown package manager' && exit 1
              fi
            "

      - name: Run IDF basic install test script (Linux only)
        if: (matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm') && matrix.run_on != 'MirrorRunner'
        run: |
          docker exec test-runner \
            bash -c "
              python3 --version
              npm run test-CLI --file=CLI-basic
            "
        continue-on-error: true

      - name: Run IDF extended install test script (Linux only)
        if: (matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm') && matrix.run_on != 'MirrorRunner' && inputs.run_extended == 'true'
        run: |
          docker exec test-runner \
            bash -c "
              python3 --version
              npm run test-CLI --file=CLI-extended
            "
        continue-on-error: true

      # MacOS steps

      - name: Install pre-requisites (MacOS)
        if: matrix.os == 'macos-latest' || matrix.os == 'macos-15-intel'
        run: |
          brew install dfu-util libgcrypt glib pixman sdl2 libslirp

      - name: Run IDF basic install test script (MacOS)
        if: matrix.os == 'macos-latest' || matrix.os == 'macos-15-intel'
        run: |
          python3 --version
          which python3
          export LOG_TO_FILE="true"
          export PACKAGE_NAME="${{ matrix.package_name }}"
          export EIM_CLI_PATH="../artifacts/eim"
          export EIM_CLI_VERSION="eim ${{ env.CLI_TAG }}"
          cd tests
          npm ci
          npm run test-CLI --file=CLI-basic
        continue-on-error: true

      - name: Run IDF extended install test script (MacOS)
        if: matrix.os == 'macos-latest' && inputs.run_extended == 'true'
        run: |
          python3 --version
          export LOG_TO_FILE="true"
          export PACKAGE_NAME="${{ matrix.package_name }}"
          export EIM_CLI_PATH="../artifacts/eim"
          export EIM_CLI_VERSION="eim ${{ env.CLI_TAG }}"
          cd tests
          npm run test-CLI --file=CLI-extended
        continue-on-error: true

      # MirrorRunner

      - name: Install pre-requisites (MirrorRunner)
        if: matrix.run_on == 'MirrorRunner' && inputs.run_self_hosted == 'false'
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake wget flex bison gperf ccache libffi-dev libssl-dev dfu-util libusb-1.0-0-dev python3 python3-pip python3-venv
        continue-on-error: true

      - name: Run mirrors basic test script (MirrorRunner)
        if: matrix.run_on == 'MirrorRunner'
        run: |
          python3 --version
          export LOG_TO_FILE="true"
          export PACKAGE_NAME="${{ matrix.package_name }}"
          export EIM_CLI_PATH="../artifacts/eim"
          export EIM_CLI_VERSION="eim ${{ env.CLI_TAG }}"
          cd tests
          npm ci
          npm run test-CLI --file=CLI-mirrors-basic
        continue-on-error: true

      - name: Run mirrors extended test script (MirrorRunner)
        if: matrix.run_on == 'MirrorRunner' && inputs.run_extended == 'true'
        run: |
          python3 --version        
          export LOG_TO_FILE="true"
          export PACKAGE_NAME="${{ matrix.package_name }}"
          export EIM_CLI_PATH="../artifacts/eim"
          export EIM_CLI_VERSION="eim ${{ env.CLI_TAG }}"
          cd tests
          npm ci
          npm run test-CLI --file=CLI-mirrors-extended
        continue-on-error: true

      # Windows steps

      - name: Exclude workspace from Defender (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          Add-MpPreference -ExclusionPath "${{ github.workspace }}"

      - name: Get CLI application version number (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          git fetch --tags
          $LATEST_TAG = (git tag --sort=-creatordate | Where-Object { $_ -match '^v[0-9]+\.[0-9]+\.[0-9]+$' } | Select-Object -First 1)
          $STRIPPED_TAG = $LATEST_TAG -replace '^v', ''
          echo "CLI_TAG=$STRIPPED_TAG" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Check artifact (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          ls ./artifacts/

      - name: Expand node modules (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          Set-Location -Path "./tests"
          Expand-Archive node_modules.zip

      - name: Remove python and git from PATH (Windows)
        if: matrix.os == 'windows-latest' && matrix.distro_name == 'scoop'
        run: |
          echo $env:PATH
          $env:PATH = ($env:PATH -split ';' | Where-Object { $_ -notmatch '[Pp]ython' }) -join ';'
          $env:PATH = ($env:PATH -split ';' | Where-Object { $_ -notmatch '\\[Gg]it\\' }) -join ';'
          echo $env:PATH
          echo "PATH=$env:PATH" >> $env:GITHUB_ENV

      - name: Run prerequisites check and install (Windows)
        if: matrix.os == 'windows-latest' && matrix.distro_name == 'scoop'
        run: |
          $env:LOG_TO_FILE="true"
          $env:PREREQUISITES_OS="windows"
          $env:EIM_CLI_PATH = "..\artifacts\eim.exe"
          $env:EIM_CLI_VERSION = "eim ${{ env.CLI_TAG }}"
          Set-Location -Path "./tests"
          npm run test-CLI-win --file=CLI-prerequisites
        continue-on-error: true

      - name: Run python check and install (Windows)
        if: matrix.os == 'windows-latest' && matrix.distro_name == 'scoop'
        run: |
          $env:LOG_TO_FILE="true"
          $env:EIM_CLI_PATH = "..\artifacts\eim.exe"
          $env:EIM_CLI_VERSION = "eim ${{ env.CLI_TAG }}"
          Set-Location -Path "./tests"
          npm run test-CLI-win --file=CLI-pythoncheck
        continue-on-error: true



      - name: Run IDF basic install test script (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          python3 --version        
          $env:LOG_TO_FILE="true"
          $env:PACKAGE_NAME="${{ matrix.package_name }}"
          $env:EIM_CLI_PATH = "..\artifacts\eim.exe"
          $env:EIM_CLI_VERSION = "eim ${{ env.CLI_TAG }}"
          Set-Location -Path "./tests"
          npm run test-CLI-win --file=CLI-basic
        continue-on-error: true

      - name: Run IDF extended install test script (Windows)
        if: matrix.os == 'windows-latest' && inputs.run_extended == 'true'
        run: |
          python3 --version        
          $env:LOG_TO_FILE="true"
          $env:PACKAGE_NAME="${{ matrix.package_name }}"
          $env:EIM_CLI_PATH = "..\artifacts\eim.exe"
          $env:EIM_CLI_VERSION = "eim ${{ env.CLI_TAG }}"
          Set-Location -Path "./tests"
          npm run test-CLI-win --file=CLI-extended
        continue-on-error: true

      # Copy eim log files to standard location for easier access

      - name: Copy EIM logs from container (Linux only)
        if: (matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm') && matrix.run_on != 'MirrorRunner'
        run: |
          docker cp test-runner:/root/.local/share/eim/logs/. ./tests/ 2>/dev/null || true

      - name: Copy EIM Log files (MirrorRnner & self hosted)
        if: matrix.run_on == 'MirrorRunner'
        run: |
          cp ~/.local/share/eim/logs/*.log ./tests/
        continue-on-error: true

      - name: Copy EIM Log files (MacOS)
        if: matrix.os == 'macos-latest' || matrix.os == 'macos-15-intel'
        run: |
          cp ~/Library/Application\ Support/eim/logs/*.log ./tests/
        continue-on-error: true

      - name: Copy EIM Log files (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          Move-Item -Path "$env:LOCALAPPDATA\eim\logs\*" -Destination ".\tests\" -Force
        continue-on-error: true

      # Upload test results
      - name: Upload test results (non-windows)
        uses: actions/upload-artifact@v4
        if: matrix.os != 'windows-latest'
        with:
          name: autotest-CLI-results-${{ matrix.package_name }}${{ matrix.run_on == 'MirrorRunner' && '-AlternateMirrors' || '' }}${{ matrix.os == 'self-hosted' && '-CN' || '' }}${{matrix.distro_name || ''}}
          path: |
            ./tests/results-*.json
            ./tests/*.log

      - name: Upload test results (windows)
        uses: actions/upload-artifact@v4
        if: matrix.os == 'windows-latest'
        with:
          name: autotest-CLI-results-${{ matrix.package_name }}
          path: |
            ./tests/results-*.json
            ./tests/*.log

      - name: Clean Up runner (Self-hosted MirrorRunner)
        if: matrix.run_on == 'MirrorRunner' && matrix.os == 'self-hosted'
        run: |
          rm -rf ~/.local/share/eim
          rm -rf ~/runner/_work/idf-im-ui
        continue-on-error: true

      # Publish test results
      - name: Publish Test Results
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: CLI-Autotests-${{ matrix.package_name }}
          path: ./tests/results-*.json
          path-replace-backslashes: "false"
          reporter: mocha-json
          fail-on-empty: true

      # Clean up Container
      - name: Stop test container
        if: (matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-24.04-arm')
        run: |
          docker stop test-runner
          docker rm test-runner
